generator client {
  provider = "prisma-client-js"
  output   = "../lib/generated/prisma"
}

datasource db {
  provider  = "postgresql"
  url       = env("DIRECT_URL")
  directUrl = env("DIRECT_URL")
}

/**
 * Device Model
 *
 * LEARNING: This table stores information about physical sensor devices
 *
 * STRUCTURE:
 * - device_id: Unique string identifier (e.g., "SENSOR_001")
 * - name: Human-readable format "L8_53_12" meaning Lamela-8, Building-53, Apartment-12
 * - location: Just the lamela part (e.g., "L8")
 * - device_type: Enum for different sensor types
 * - description: Optional notes about the device
 *
 * IMPORTANT: The device_id (STRING) in this table does NOT directly map
 * to device_id (INT) in thermionyx_measurements table. The relationship
 * is indirect - you need to parse the 'name' field to understand which
 * apartment/building a device belongs to.
 */
model Device {
  device_id         String                           @id @db.VarChar
  device_type       Unsupported("device_type_enum")?
  location          String?                          @db.VarChar
  description       String?
  // COMMENT: name is structured like "L8_53_12" (Lamela-8, Building-53, Apartment-12)
  // location shows just "L8" (the lamela)
  // device_id is the primary key
  name              String?

  @@map("devices")
}

model scada_measurements {
  datetime   DateTime @db.Timestamp(6)
  location   String   @db.VarChar
  t_amb      Float?
  t_ref      Float?
  t_sup_prim Float?
  t_ret_prim Float?
  t_sup_sec  Float?
  t_ret_sec  Float?
  e          Float?
  pe         Float?

  @@id([datetime, location])
}

model thermionyx_measurements {
  datetime          DateTime @db.Timestamp(6)
  device_id         Int
  probe_id          Int
  temperature       Float?
  relative_humidity Float?
  co2               Float?

  @@id([datetime, device_id, probe_id])
}

/**
 * User Settings Model
 * COMMENT: This stores per-user expected temperature and pressure ranges
 * that will be used to determine warning states (too high/too low) on the dashboard
 * The user_id maps to Supabase Auth user UUID
 */
model UserSettings {
  id                    String   @id @default(uuid()) @db.Uuid
  user_id               String   @unique @db.Uuid // Supabase Auth user ID

  // Temperature range settings (in Celsius)
  // COMMENT: These define what the user considers "normal" operating temperature
  // Values outside this range will trigger visual warnings (red/blue backgrounds)
  expected_temp_min     Float    @default(23.0)
  expected_temp_max     Float    @default(26.0)

  // Pressure range settings (unit should be consistent across your system)
  // COMMENT: Similar to temperature, these define acceptable pressure bounds
  expected_pressure_min Float    @default(1.5)
  expected_pressure_max Float    @default(2.5)

  // CO2 range settings (in ppm - parts per million)
  // COMMENT: Acceptable CO2 levels for indoor air quality
  // Typical ranges: 400-1000 ppm is good, >1000 ppm indicates poor ventilation
  expected_co2_min      Float    @default(400.0)
  expected_co2_max      Float    @default(1000.0)

  // Metadata
  created_at            DateTime @default(now()) @db.Timestamp(6)
  updated_at            DateTime @updatedAt @db.Timestamp(6)

  @@map("user_settings")
}

model weatherlink_measurements {
  datetime              DateTime  @db.Timestamp(6)
  location              String    @default("WeatherStation1") @db.VarChar
  bar_trend             Int?
  bar                   Float?
  temp_in               Float?
  hum_in                Int?
  temp_out              Float?
  wind_speed            Float?
  wind_speed_10_min_avg Float?
  wind_dir              Int?
  hum_out               Int?
  rain_rate_mm          Float?
  uv                    Float?
  solar_rad             Float?
  rain_storm_mm         Float?
  rain_storm_start_date DateTime? @db.Timestamp(6)
  rain_day_mm           Float?
  rain_month_mm         Float?
  rain_year_mm          Float?
  et_day                Float?
  et_month              Float?
  et_year               Float?
  wet_leaf_4            Int?
  forecast_rule         Int?
  forecast_desc         String?
  dew_point             Int?
  heat_index            Float?
  wind_chill            Float?
  wind_gust_10_min      Float?

  @@id([datetime, location])
}

/**
 * Alert Type Enum
 * COMMENT: Defines the type of threshold violation that triggered the alert
 * - TEMP_HIGH/LOW: Temperature outside expected range
 * - PRESSURE_HIGH/LOW: Pressure outside expected range (SCADA only)
 * - HUMIDITY_HIGH/LOW: Humidity outside expected range
 * - CO2_HIGH/LOW: CO2 levels outside expected range (Thermionix only)
 */
enum AlertType {
  TEMP_HIGH
  TEMP_LOW
  PRESSURE_HIGH
  PRESSURE_LOW
  HUMIDITY_HIGH
  HUMIDITY_LOW
  CO2_HIGH
  CO2_LOW
}

/**
 * Alert Source Enum
 * COMMENT: Identifies which monitoring system generated the alert
 * - THERMIONIX: Apartment temperature/humidity/CO2 sensors
 * - SCADA: Building heating system (temperature/pressure)
 * - WEATHERLINK: External weather station
 */
enum AlertSource {
  THERMIONIX
  SCADA
  WEATHERLINK
}

/**
 * Alert Severity Enum
 * COMMENT: Indicates urgency level of the alert
 * - LOW: Minor deviation, informational
 * - MEDIUM: Notable deviation, should be reviewed (default)
 * - HIGH: Critical deviation, requires immediate attention
 */
enum AlertSeverity {
  LOW
  MEDIUM
  HIGH
}

/**
 * Alert Model
 * COMMENT: Stores threshold violation alerts for temperature, pressure, humidity, and CO2
 *
 * PURPOSE:
 * - Track when measured values exceed user-defined expected ranges
 * - Enable real-time notifications via Supabase Realtime
 * - Support deep-linking to specific devices/locations
 * - Provide alert history and acknowledgment tracking
 *
 * WORKFLOW:
 * 1. Background worker detects measurement outside expected range
 * 2. Creates Alert record with measured_value and threshold_value
 * 3. User sees unread count badge in header (is_read = false)
 * 4. User clicks alert, navigates to device/location
 * 5. Alert marked as read (is_read = true)
 * 6. Worker can acknowledge alert (is_acknowledged = true)
 * 7. When value returns to normal, resolved_at is set
 *
 * DEEP-LINKING:
 * - Thermionix: device_id + apartment_name -> /dashboard/thermionix?apartment={device_id}
 * - SCADA: location -> /dashboard/scada?lamela={location}
 * - WeatherLink: source only -> /dashboard/weatherlink
 */
model Alert {
  // Primary Key
  id                String        @id @default(uuid()) @db.Uuid

  // Alert Classification
  alert_type        AlertType     // What threshold was violated (TEMP_HIGH, PRESSURE_LOW, etc.)
  source            AlertSource   // Which system generated it (THERMIONIX, SCADA, WEATHERLINK)
  severity          AlertSeverity @default(MEDIUM) // Urgency level

  // Source Identification
  // COMMENT: These fields enable deep-linking to the specific device/location
  device_id         String?       @db.VarChar // For Thermionix: matches Device.device_id
  location          String?       @db.VarChar // For SCADA: lamela identifier like "L8"
  apartment_name    String?       @db.VarChar // For Thermionix: human-readable like "L8_33_67"

  // Measurement Details
  // COMMENT: Store both the violating value and the threshold for context
  measured_value    Float         // The actual value that triggered the alert
  threshold_value   Float         // The expected min/max that was exceeded
  measurement_time  DateTime      @db.Timestamp(6) // When the violation occurred
  unit              String        @db.VarChar // Units: "Â°C", "bar", "%", "ppm"

  // User Interaction State
  // COMMENT: Track whether user has seen and/or acknowledged the alert
  is_read           Boolean       @default(false) // For header badge unread count
  is_acknowledged   Boolean       @default(false) // Worker marked as handled
  acknowledged_at   DateTime?     @db.Timestamp(6) // When acknowledged
  acknowledged_by   String?       @db.Uuid // User who acknowledged (for audit trail)

  // Resolution Tracking
  // COMMENT: Automatically set when measured value returns to expected range
  resolved_at       DateTime?     @db.Timestamp(6) // When value returned to normal

  // User Association
  // COMMENT: Each alert belongs to a specific user based on their settings
  user_id           String        @db.Uuid // Foreign key to Supabase Auth user

  // Metadata
  created_at        DateTime      @default(now()) @db.Timestamp(6)
  updated_at        DateTime      @updatedAt @db.Timestamp(6)

  // Performance Indexes
  // COMMENT: Optimized for common query patterns
  @@index([user_id, is_read])           // Quick unread count queries
  @@index([user_id, is_acknowledged])   // Filter acknowledged alerts
  @@index([created_at])                 // Time-based sorting and filtering
  @@index([source, device_id])          // Group by source/device for deduplication
  @@index([user_id, created_at])        // User's recent alerts

  @@map("alerts")
}
